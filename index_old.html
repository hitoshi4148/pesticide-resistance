<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>農薬検索システム</title>
</head>
<body>
  <h1>農薬検索</h1>
  <input type="text" id="keyword" placeholder="農薬名を入力">
  <button onclick="doSearch()">検索</button>

  <div id="results"></div>
  <div id="detail"></div>

<script>
let currentDetail = null;
let currentRAC = null;

async function doSearch() {
  const keyword = document.getElementById("keyword").value;
  if (!keyword) return;

  const response = await fetch(`/search?keyword=${encodeURIComponent(keyword)}`);
  const results = await response.json();

  let html = "<table border='1'><tr><th>登録番号</th><th>用途</th><th>農薬の名称</th><th>メーカー</th><th>選択</th></tr>";
  results.forEach(row => {
    html += `<tr>
      <td>${row["登録番号"]}</td>
      <td>${row["用途"]}</td>
      <td>${row["農薬の名称"]}</td>
      <td>${row["メーカー"]}</td>
      <td><button onclick="loadDetail('${row["登録番号"]}')">選択</button></td>
    </tr>`;
  });
  html += "</table>";
  document.getElementById("results").innerHTML = html;
  document.getElementById("detail").innerHTML = "";
}

async function loadDetail(reg) {
  const response = await fetch(`/detail?reg=${reg}`);
  const data = await response.json();
  currentDetail = data.detail;
  currentRAC = data.racList;
  showDetail();
}

function showDetail() {
  if (!currentDetail || currentDetail.length === 0) return;
  const entry = currentDetail[0];

  let html = `<h2>農薬詳細</h2>
    <p>農薬の名称: ${entry["農薬の名称_x"]}</p>
    <button onclick="showApplications()">適用情報</button>`;

  // RACコードごとのボタン
  currentRAC.forEach(r => {
    html += ` <button onclick="showRAC('${r.rac_type}','${r.rac_code}')">[${r.rac_type} ${r.rac_code}]</button>`;
  });

  document.getElementById("detail").innerHTML = html;
  showApplications();
}

function showApplications() {
  if (!currentDetail) return;
  let html = "<h3>適用情報</h3>";
  html += "<table border='1'><tr><th>作物名</th><th>適用場所</th><th>適用病害虫雑草名</th><th>有効成分</th><th>成分量</th><th>希釈倍率使用量</th><th>散布液量</th><th>使用時期</th><th>総使用回数</th><th>使用方法</th></tr>";

  currentDetail.forEach(row => {
    html += `<tr>
      <td>${row["作物名"] || "－"}</td>
      <td>${row["適用場所"] || "－"}</td>
      <td>${row["適用病害虫雑草名"] || "－"}</td>
      <td>${row["有効成分"] || "－"}</td>
      <td>${row["濃度"] || "－"}</td>
      <td>${row["希釈倍数使用量"] || "－"}</td>
      <td>${row["散布液量"] || "－"}</td>
      <td>${row["使用時期"] || "－"}</td>
      <td>${row["有効成分①を含む農薬の総使用回数"] || "－"}</td>
      <td>${row["使用方法"] || "－"}</td>
    </tr>`;
  });
  html += "</table>";
  document.getElementById("detail").innerHTML += html;
}

async function showRAC(type, code) {
  const racDetail = currentRAC.find(r => r.rac_type === type && String(r.rac_code) === String(code));

  let html = "<h3>RAC情報</h3>";
  html += "<table border='1'><tr><th>RACタイプ</th><th>RACコード</th><th>グループ名</th><th>作用機構</th><th>成分名</th></tr>";
  html += `<tr>
    <td>${racDetail.rac_type}</td>
    <td>${racDetail.rac_code}</td>
    <td>${racDetail.group_name}</td>
    <td>${racDetail.made_of_action}</td>
    <td>${racDetail.examples}</td>
  </tr></table>`;

  // 同一グループ農薬一覧を取得
  const response = await fetch(`/racgroup?type=${type}&code=${code}`);
  const groupList = await response.json();

  html += "<h4>同一グループ農薬</h4>";
  html += "<table border='1'><tr><th>登録番号</th><th>農薬の名称</th><th>メーカー</th></tr>";
  groupList.forEach(row => {
    html += `<tr>
      <td>${row["登録番号"]}</td>
      <td>${row["農薬の名称"]}</td>
      <td>${row["メーカー"]}</td>
    </tr>`;
  });
  html += "</table>";

  document.getElementById("detail").innerHTML += html;
}
</script>
</body>
</html>
